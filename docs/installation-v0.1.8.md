# Инструкция по установке и проверке com_radicalmart_telegram v0.1.8

## Что исправлено в версии 0.1.8

### 1. Исправлено логирование для Joomla 5
- ✅ Добавлен метод `initLogger()` для правильной инициализации логирования
- ✅ Исправлены все вызовы `Log::add()` - третий параметр теперь массив: `['com_radicalmart_telegram']`
- ✅ Логи теперь будут записываться в файл `administrator/logs/com_radicalmart_telegram.php`

### 2. Добавлено подробное логирование процесса обновления ПВЗ
Теперь логируются:
- Старт процесса с указанием провайдеров
- Количество точек для каждого провайдера (из API)
- Загрузка каждого чанка данных (offset, количество)
- Предупреждения при пустых чанках
- Успешное завершение с итоговым количеством
- Ошибки с полным текстом исключения

### 3. Исправления SQL-запросов
- ✅ Заменены `onDuplicateKeyUpdate()` на прямой SQL с `ON DUPLICATE KEY UPDATE`
- ✅ Используется `VALUES()` функция MySQL

## Инструкция по установке

1. **Скачайте пакет**: `github\RMTelegram\dist\pkg_radicalmart_telegram-0.1.8.zip`

2. **Установите через админку Joomla**:
   - Система → Установка → Расширения
   - Загрузите ZIP-файл
   - Дождитесь успешной установки

3. **Проверьте настройки компонента**:
   - Компоненты → RadicalMart Telegram → Настройки (Configuration)
   - Убедитесь, что заполнены:
     - **ApiShip API Key**: ваш API ключ от ApiShip
     - **ApiShip Providers**: список провайдеров через запятую (например: `cdek,boxberry,dpd`)

## Инструкция по проверке

### Шаг 1: Обновление базы ПВЗ

1. Перейдите в **Компоненты → RadicalMart Telegram → Status**
2. Нажмите кнопку **"Обновить базу ПВЗ"**
3. Дождитесь перенаправления на страницу статуса

### Шаг 2: Проверка результата

После обновления на странице Status должна появиться таблица с данными:
- **Provider**: имя провайдера (cdek, boxberry и т.д.)
- **Last Fetch**: дата и время последнего обновления
- **Last Total**: количество загруженных точек

**Если показывает 0 точек** - переходите к шагу 3.

### Шаг 3: Проверка логов

1. Откройте файл логов:
   ```
   administrator/logs/com_radicalmart_telegram.php
   ```

2. Ищите записи с текущей датой. Должны быть такие строки:
   ```
   [TIMESTAMP] INFO ApiShip fetch started: providers=cdek,boxberry
   [TIMESTAMP] INFO ApiShip provider 'cdek': total points = 1234
   [TIMESTAMP] INFO ApiShip provider 'cdek': fetched 500 points at offset 0
   [TIMESTAMP] INFO ApiShip provider 'cdek': fetched 500 points at offset 500
   ...
   [TIMESTAMP] INFO ApiShip fetch completed: total=2468, providers=cdek,boxberry
   ```

### Возможные проблемы и их решения

#### 1. В логах: "missing token or providers"
**Проблема**: Не настроены API ключ или список провайдеров
**Решение**: Проверьте настройки компонента (см. выше)

#### 2. В логах: "total points = 0" для всех провайдеров
**Проблема**:
- Неверный API ключ ApiShip
- Провайдер написан с ошибкой
- API ApiShip недоступен

**Решение**:
- Проверьте правильность API ключа в личном кабинете ApiShip
- Проверьте правильность названий провайдеров (должны быть в нижнем регистре)
- Попробуйте открыть https://apiship.ru в браузере

#### 3. В логах: "fetched N points" но на странице Status показывает 0
**Проблема**: Данные загружаются из API, но не сохраняются в базу
**Возможные причины**:
- Ошибка SQL-запроса (должна быть в логах после строки "fetched")
- Проблемы с правами доступа к базе данных
- Отсутствуют таблицы в базе

**Решение**:
- Проверьте полный текст лога на наличие строк с "ERROR"
- Проверьте наличие таблиц в базе:
  - `tw9cs_radicalmart_apiship_points`
  - `tw9cs_radicalmart_apiship_meta`

#### 4. Логи вообще не создаются
**Проблема**: Нет прав на запись в директорию `administrator/logs/`
**Решение**: Проверьте права доступа к директории (должны быть 755 или 777)

## Скрипт для проверки базы данных

Если у вас есть прямой доступ к базе данных, можно использовать скрипт `check_apiship_db.php`:

```bash
php check_apiship_db.php
```

Он покажет:
- Количество записей в таблице метаданных
- Количество точек в базе по каждому провайдеру
- Примеры загруженных точек
- Настройки компонента из базы
- Структуру таблицы

**Примечание**: Скрипт использует данные из `configuration.php` для подключения к базе.

## Техническая информация

### Таблицы базы данных

1. **`#__radicalmart_apiship_points`** - пункты выдачи заказов
   - `provider` - код провайдера (cdek, boxberry и т.д.)
   - `ext_id` - внешний ID точки
   - `title` - название точки
   - `address` - адрес
   - `lat`, `lon` - координаты
   - `point` - геометрическая точка (POINT)
   - `meta` - полные данные в JSON
   - `operation` - тип операции (giveout)
   - `updated_at` - дата обновления

2. **`#__radicalmart_apiship_meta`** - метаданные обновлений
   - `provider` - код провайдера
   - `last_fetch` - дата последнего обновления
   - `last_total` - количество точек

### Файлы логов

- **Основной лог**: `administrator/logs/com_radicalmart_telegram.php`
- **Формат**: `{DATETIME} {PRIORITY} {MESSAGE}`
- **Уровни**: INFO, WARNING, ERROR

### API методы

Компонент использует класс `ApiShipHelper` из плагина `radicalmart_shipping/apiship`:
- `getPointsTotal($token, $providers, $operations)` - получить общее количество точек
- `getPoints($token, $providers, $operations, $offset, $limit)` - получить порцию точек

## Контакты для поддержки

Если проблема не решается:
1. Соберите полный лог из `administrator/logs/com_radicalmart_telegram.php`
2. Сделайте скриншот страницы Status
3. Проверьте настройки компонента
4. Приложите информацию к issue в репозитории
