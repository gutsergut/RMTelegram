# Настройка юридических документов для Telegram-бота

## Обзор

В версии 5.0.1 добавлена возможность выбирать статьи Joomla с юридическими документами прямо в настройках компонента. Это позволяет:

- Управлять контентом документов через стандартный редактор Joomla
- Обновлять тексты без правки кода
- Использовать версионность и историю изменений
- Применять разные шаблоны оформления
- Легко менять URL документов при реструктуризации сайта

## Настройки компонента

Перейдите в **Components → Telegram Магазин → Options → Legal Documents**:

### Поля настроек

1. **Политика конфиденциальности** (`article_privacy_policy`)
   - Статья с полным текстом Политики обработки персональных данных
   - Используется в ссылках при запросе согласия в боте

2. **Согласие на обработку ПД** (`article_consent_personal_data`)
   - Статья с текстом Согласия на обработку персональных данных
   - Отправляется пользователю перед первым использованием бота
   - **Обязательно для соответствия ФЗ-152**

3. **Пользовательское соглашение** (`article_terms_of_service`)
   - Статья с Условиями использования (публичная оферта)
   - Может использоваться в информационных сообщениях

4. **Согласие на рассылки** (`article_consent_marketing`)
   - Статья с согласием на получение рекламных материалов
   - Используется при подписке на рассылки (будущий функционал)
   - **Обязательно для соответствия ФЗ-38 "О рекламе"**

## Пошаговая инструкция

### Шаг 1: Создайте статьи в Joomla

1. Перейдите в **Content → Articles → New**
2. Создайте 4 статьи со следующими заголовками:
   - "Политика конфиденциальности"
   - "Согласие на обработку персональных данных"
   - "Пользовательское соглашение"
   - "Согласие на получение рассылок"

3. Скопируйте содержимое из файлов `/docs/`:
   - `privacy-policy.md` → статья "Политика конфиденциальности"
   - `consent-personal-data.md` → статья "Согласие на обработку ПД"
   - `terms-of-service.md` → статья "Пользовательское соглашение"
   - `consent-marketing.md` → статья "Согласие на получение рассылок"

4. Настройте параметры статей:
   - **Category**: создайте категорию "Правовые документы"
   - **Access**: Public
   - **Status**: Published
   - **Featured**: No (чтобы не показывались в блогах)

### Шаг 2: Настройте меню (опционально)

Создайте пункты меню для удобного доступа к документам:

1. **Menus → Main Menu → New**
2. **Menu Item Type**: Articles → Single Article
3. Выберите созданную статью
4. Рекомендуемые URL Alias:
   - `privacy` для Политики конфиденциальности
   - `consent` для Согласия на ПД
   - `terms` для Пользовательского соглашения
   - `consent-marketing` для Согласия на рассылки

### Шаг 3: Свяжите статьи в настройках компонента

1. **Components → Telegram Магазин → Options**
2. Откройте вкладку **Legal Documents**
3. Для каждого поля нажмите **Select** и выберите соответствующую статью
4. Нажмите **Save & Close**

### Шаг 4: Проверьте работу

1. Откройте Telegram-бот
2. Отправьте команду `/start` (если ранее не давали согласие)
3. Убедитесь, что ссылка в сообщении о согласии ведет на правильную статью
4. Проверьте, что страница открывается корректно на мобильном устройстве

## Как это работает

### ConsentHelper::getDocumentUrl()

Метод автоматически:
1. Читает ID статьи из настроек компонента
2. Формирует полный URL через Router Joomla
3. Возвращает готовую ссылку для использования в боте

**Пример использования:**

```php
use Joomla\Component\RadicalMartTelegram\Site\Helper\ConsentHelper;

// Получить URL одного документа
$consentUrl = ConsentHelper::getDocumentUrl('consent');

// Получить все URL
$urls = ConsentHelper::getAllDocumentUrls();
// ['privacy' => '...', 'consent' => '...', 'terms' => '...', 'marketing' => '...']
```

### Fallback на языковые константы

Если статья не выбрана в настройках, бот будет использовать URL из языковых констант:

```ini
COM_RADICALMART_TELEGRAM_CONSENT_URL="https://cacao.land/consent"
COM_RADICALMART_TELEGRAM_PRIVACY_POLICY_URL="https://cacao.land/privacy"
```

Это обеспечивает обратную совместимость.

## Рекомендации

### SEO и индексация

- Откройте документы для индексации роботами
- Добавьте в sitemap.xml
- Используйте канонические URL через пункты меню

### Мобильная версия

- Проверьте отображение на мобильных устройствах
- Убедитесь, что шрифты читаемы
- Используйте адаптивный шаблон

### Версионность

- Включите версионность контента в Joomla (Content History)
- При обновлении документов указывайте дату в тексте
- Сохраняйте резервные копии перед изменениями

### Уведомления об изменениях

При существенном изменении документов:
1. Обновите дату в тексте статьи
2. Отправьте уведомление пользователям через рассылку (после реализации)
3. Запросите повторное согласие при критических изменениях

## Миграция с hardcoded URL

Если ранее использовались жестко заданные ссылки:

1. Создайте статьи (Шаг 1)
2. Настройте пункты меню с теми же URL alias (Шаг 2)
3. Свяжите статьи в компоненте (Шаг 3)
4. Удалите старые константы из языковых файлов (опционально)

## Технические детали

### Таблица настроек

Значения хранятся в `#__extensions.params`:

```json
{
  "article_privacy_policy": "123",
  "article_consent_personal_data": "124",
  "article_terms_of_service": "125",
  "article_consent_marketing": "126"
}
```

### Тип поля: modal_article

Стандартный компонент Joomla для выбора статей (как в плагине privacyconsent). Преимущества:
- Модальное окно с поиском по названию
- Кнопки для создания новой статьи
- Редактирование выбранной статьи
- Очистка выбора (Clear)
- Валидация существования статьи
- Автоматическое обновление при переименовании

### API endpoint для получения URL

Если нужно получить URL из внешнего скрипта:

```php
$params = ComponentHelper::getParams('com_radicalmart_telegram');
$articleId = (int) $params->get('article_consent_personal_data', 0);

if ($articleId > 0) {
    $url = Route::link('site', 'index.php?option=com_content&view=article&id=' . $articleId, false, Route::TLS_IGNORE, true);
}
```

## Поддержка

При возникновении проблем:

1. Проверьте, что статьи опубликованы и доступны (Access Level = Public)
2. Убедитесь, что ID статей корректны в настройках компонента
3. Очистите кэш Joomla (**System → Clear Cache**)
4. Проверьте логи компонента: `administrator/logs/com_radicalmart.telegram.php`

---

**Дата создания**: 10 ноября 2025 г.
**Версия компонента**: 5.0.1+
