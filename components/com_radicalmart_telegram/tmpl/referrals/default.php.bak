<?php
defined('_JEXEC') or die;

use Joomla\CMS\Language\Text;
use Joomla\CMS\Uri\Uri;
use Joomla\CMS\HTML\HTMLHelper;
use Joomla\CMS\Factory;

// Explicitly load language file
Factory::getLanguage()->load('com_radicalmart_telegram', JPATH_SITE);

$root = rtrim(Uri::root(), '/');
$app = \Joomla\CMS\Factory::getApplication();
$chat = $app->input->getInt('chat', 0);
$chatId = $this->tgUser['chat_id'] ?? $chat;
$baseQuery = $chatId > 0 ? '&chat=' . $chatId : '';
?>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title><?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS'); ?></title>
    <link rel="stylesheet" href="<?php echo $root; ?>/templates/yootheme/css/theme.css">
    <script src="<?php echo $root; ?>/templates/yootheme/vendor/assets/uikit/dist/js/uikit.min.js"></script>
    <script src="<?php echo $root; ?>/templates/yootheme/vendor/assets/uikit/dist/js/uikit-icons.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        html, body { background: #ffffff !important; color: #222 !important; margin: 0; padding: 0; }
        body { padding-bottom: 52px; }
        body.contentpane { padding: 0 !important; margin: 0 !important; }

        /* Bottom nav - same as app page */
        #app-bottom-nav { position: fixed; left: 0; right: 0; bottom: 0; z-index: 10005; }
        #app-bottom-nav .uk-navbar-nav > li > a { padding: 4px 8px; line-height: 1.05; min-height: 50px; position: relative; }
        #app-bottom-nav .tg-safe-text { display: inline-flex; align-items: center; }
        #app-bottom-nav .bottom-tab { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; }
        #app-bottom-nav .bottom-tab .caption { display: block; margin-top: 1px; font-size: 10px; }
        #app-bottom-nav .uk-icon > svg { width: 18px; height: 18px; }

        /* Referrals specific styles */
        .referral-code-card { background: #f5f5f5; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
        .referral-code-value { font-family: monospace; font-size: 18px; font-weight: 600; color: #333; letter-spacing: 1px; }
        .referral-code-discount { font-size: 14px; color: #1e87f0; }
        .referral-code-meta { font-size: 12px; color: #999; }
        .referral-code-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; }
        .referral-code-badge.active { background: #e8f5e9; color: #2e7d32; }
        .referral-code-badge.expired { background: #ffebee; color: #c62828; }
        .referral-code-badge.used { background: #fff3e0; color: #ef6c00; }
        .referral-item { position: relative; padding: 12px 0; border-bottom: 1px solid #eee; }
        .referral-item:last-child { border-bottom: none; }
        .referral-item .level-indicator { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #1e87f0; color: #fff; font-size: 12px; font-weight: 600; margin-right: 8px; flex-shrink: 0; }
        .referral-item .level-indicator.level-2 { background: #7c4dff; }
        .referral-item .level-indicator.level-3 { background: #ff4081; }
        .referral-item .level-indicator.level-4 { background: #ff9800; }
        .referral-item .level-indicator.level-5 { background: #607d8b; }
        .sub-referrals { margin-left: 32px; margin-top: 8px; border-left: 2px solid #e0e0e0; padding-left: 12px; }
        .parent-chain-item { display: flex; align-items: center; padding: 8px 0; }
        .parent-chain-item .level-badge { background: #f0f0f0; padding: 2px 8px; border-radius: 8px; font-size: 11px; margin-right: 8px; }
        .stats-card { background: linear-gradient(135deg, #1e87f0 0%, #7c4dff 100%); border-radius: 12px; padding: 20px; color: #fff; margin-bottom: 16px; }
        .stats-card .stats-value { font-size: 28px; font-weight: 700; }
        .stats-card .stats-label { font-size: 13px; opacity: 0.9; }
        .copy-btn { background: #1e87f0; color: #fff; border: none; border-radius: 8px; padding: 8px 16px; font-size: 13px; cursor: pointer; transition: opacity 0.2s; }
        .copy-btn:hover { opacity: 0.9; }
        .copy-btn.copied { background: #4caf50; }
    </style>
    <script>
        // Force light theme
        (function(){
            document.documentElement.style.setProperty('--tg-theme-bg-color', '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-text-color', '#222222');
            document.documentElement.style.setProperty('--tg-theme-hint-color', '#999999');
            document.documentElement.style.setProperty('--tg-theme-link-color', '#2678b6');
            document.documentElement.style.setProperty('--tg-theme-button-color', '#3390ec');
            document.documentElement.style.setProperty('--tg-theme-button-text-color', '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', '#f5f5f5');
        })();
    </script>
</head>
<body>
<div id="referrals-app" class="uk-container uk-container-small uk-padding-small">
    <div class="uk-flex uk-flex-middle uk-margin-small-bottom">
        <a href="<?php echo $root; ?>/index.php?option=com_radicalmart_telegram&view=profile<?php echo $baseQuery; ?>" class="uk-margin-small-right" uk-icon="icon: arrow-left"></a>
        <h1 class="uk-h3 uk-margin-remove"><?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS'); ?></h1>
    </div>

    <?php if (!$this->userId): ?>
    <div class="uk-card uk-card-default uk-card-body uk-text-center">
        <span uk-icon="icon: lock; ratio: 2" class="uk-text-muted"></span>
        <p class="uk-margin-small-top"><?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_LOGIN_REQUIRED'); ?></p>
    </div>

    <?php elseif (!$this->inChain): ?>
    <div class="uk-card uk-card-default uk-card-body uk-text-center">
        <span uk-icon="icon: users; ratio: 2" class="uk-text-muted"></span>
        <h3 class="uk-margin-small-top"><?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_NOT_IN_PROGRAM'); ?></h3>
        <p class="uk-text-muted"><?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_NOT_IN_PROGRAM_DESC'); ?></p>
    </div>

    <?php else: ?>

    <div class="stats-card">
        <div class="uk-grid-small uk-child-width-1-2" uk-grid>
            <div>
                <div class="stats-value"><?php echo $this->referralsCount; ?></div>
                <div class="stats-label"><?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_COUNT'); ?></div>
            </div>
            <div>
                <div class="stats-value"><?php echo number_format($this->totalEarnedPoints, 0, ',', ' '); ?></div>
                <div class="stats-label"><?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_EARNED_POINTS'); ?></div>
            </div>
        </div>
    </div>

    <div class="uk-card uk-card-default uk-card-body uk-margin-bottom">
        <h3 class="uk-card-title uk-margin-small-bottom">
            <span uk-icon="icon: link" class="uk-margin-small-right"></span>
            <?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_MY_CODES'); ?>
        </h3>

        <?php if (empty($this->referralCodes)): ?>
        <p class="uk-text-muted uk-text-center uk-margin-small"><?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_NO_CODES'); ?></p>
        <?php else: ?>
            <?php foreach ($this->referralCodes as $code): ?>
            <div class="referral-code-card">
                <div class="uk-flex uk-flex-between uk-flex-middle uk-margin-small-bottom">
                    <span class="referral-code-value"><?php echo htmlspecialchars($code->code); ?></span>
                    <span class="referral-code-badge <?php echo $code->enabled ? 'active' : ($code->expires && strtotime($code->expires) < time() ? 'expired' : 'used'); ?>">
                        <?php
                        if (!$code->enabled) {
                            if ($code->expires && strtotime($code->expires) < time()) {
                                echo Text::_('COM_RADICALMART_TELEGRAM_CODE_EXPIRED');
                            } else {
                                echo Text::_('COM_RADICALMART_TELEGRAM_CODE_LIMIT_REACHED');
                            }
                        } else {
                            echo Text::_('COM_RADICALMART_TELEGRAM_CODE_ACTIVE');
                        }
                        ?>
                    </span>
                </div>

                <div class="referral-code-discount uk-margin-small-bottom">
                    <?php echo Text::sprintf('COM_RADICALMART_TELEGRAM_REFERRALS_CODE_DISCOUNT', $code->discount_string); ?>
                </div>

                <div class="referral-code-meta uk-margin-small-bottom">
                    <?php if ($code->customers_limit > 0): ?>
                    <?php echo Text::sprintf('COM_RADICALMART_TELEGRAM_REFERRALS_CODE_USAGE', $code->used_count, $code->customers_limit); ?>
                    <?php else: ?>
                    <?php echo Text::sprintf('COM_RADICALMART_TELEGRAM_REFERRALS_CODE_USED_TIMES', $code->used_count); ?>
                    <?php endif; ?>

                    <?php if ($code->expires): ?>
                    <span class="uk-margin-small-left">
                        <?php echo Text::sprintf('COM_RADICALMART_TELEGRAM_CODE_EXPIRES_AT', HTMLHelper::_('date', $code->expires, 'd.m.Y')); ?>
                    </span>
                    <?php endif; ?>
                </div>

                <?php if ($code->enabled): ?>
                <!-- Telegram ссылка (приоритетная) -->
                <?php if ($code->telegram_link): ?>
                <div class="uk-margin-small-bottom">
                    <label class="uk-form-label uk-text-small uk-text-muted">
                        <span uk-icon="icon: social; ratio: 0.7"></span> <?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_TELEGRAM_LINK'); ?>
                    </label>
                    <div class="uk-flex uk-flex-between uk-flex-middle">
                        <input type="text" value="<?php echo htmlspecialchars($code->telegram_link); ?>"
                               class="uk-input uk-form-small uk-width-expand uk-margin-small-right"
                               readonly id="tg-link-<?php echo $code->id; ?>"
                               style="font-size: 12px; background: var(--tg-theme-bg-color, #fff);">
                        <button type="button" class="copy-btn" onclick="copyTgLink(<?php echo $code->id; ?>, this)">
                            <span uk-icon="icon: copy; ratio: 0.8"></span>
                            <?php echo Text::_('COM_RADICALMART_TELEGRAM_COPY'); ?>
                        </button>
                    </div>
                </div>
                <?php endif; ?>

                <!-- Ссылка на сайт -->
                <?php if ($code->link): ?>
                <div class="uk-margin-small-bottom">
                    <label class="uk-form-label uk-text-small uk-text-muted">
                        <span uk-icon="icon: link; ratio: 0.7"></span> <?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_SITE_LINK'); ?>
                    </label>
                    <div class="uk-flex uk-flex-between uk-flex-middle">
                        <input type="text" value="<?php echo htmlspecialchars($code->link); ?>"
                               class="uk-input uk-form-small uk-width-expand uk-margin-small-right"
                               readonly id="code-link-<?php echo $code->id; ?>"
                               style="font-size: 12px; background: var(--tg-theme-bg-color, #fff);">
                        <button type="button" class="copy-btn" onclick="copyCodeLink(<?php echo $code->id; ?>, this)">
                            <span uk-icon="icon: copy; ratio: 0.8"></span>
                            <?php echo Text::_('COM_RADICALMART_TELEGRAM_COPY'); ?>
                        </button>
                    </div>
                </div>
                <?php endif; ?>
                <?php endif; ?>
            </div>
            <?php endforeach; ?>
        <?php endif; ?>

        <?php if ($this->canCreateCode): ?>
        <!-- Форма создания нового кода -->
        <div class="uk-margin-top" id="create-code-section">
            <hr class="uk-divider-small">
            <h4 class="uk-margin-small-bottom"><?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_CREATE_NEW_CODE'); ?></h4>

            <?php if ($this->templateDiscount): ?>
            <p class="uk-text-muted uk-text-small uk-margin-small-bottom">
                <?php echo Text::sprintf('COM_RADICALMART_TELEGRAM_REFERRALS_CODE_WILL_GIVE', $this->templateDiscount); ?>
            </p>
            <?php endif; ?>

            <?php if ($this->canCustomCode): ?>
            <div class="uk-margin-small">
                <input type="text" id="custom-code-input" class="uk-input"
                       placeholder="<?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_ENTER_CUSTOM_CODE'); ?>"
                       maxlength="20" pattern="[a-zA-Z0-9\-_]+"
                       style="text-transform: uppercase;">
                <p class="uk-text-meta uk-text-small uk-margin-small-top">
                    <?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_CUSTOM_CODE_HINT'); ?>
                </p>
            </div>
            <?php endif; ?>

            <button type="button" id="create-code-btn" class="uk-button uk-button-primary uk-width-1-1" onclick="createReferralCode()">
                <span uk-icon="icon: plus-circle; ratio: 0.9" class="uk-margin-small-right"></span>
                <?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_CREATE_CODE_BTN'); ?>
            </button>

            <!-- Результат создания кода -->
            <div id="create-code-result" class="uk-margin-top" style="display: none;">
                <div class="referral-code-card" style="background: #e8f5e9;">
                    <div class="uk-text-success uk-margin-small-bottom">
                        <span uk-icon="icon: check; ratio: 0.9"></span>
                        <?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_CODE_CREATED'); ?>
                    </div>
                    <div class="uk-flex uk-flex-between uk-flex-middle uk-margin-small-bottom">
                        <span class="referral-code-value" id="new-code-value"></span>
                        <span class="referral-code-badge active"><?php echo Text::_('COM_RADICALMART_TELEGRAM_CODE_ACTIVE'); ?></span>
                    </div>
                    <div class="referral-code-discount uk-margin-small-bottom" id="new-code-discount"></div>
                    <div class="uk-flex uk-flex-between uk-flex-middle">
                        <input type="text" id="new-code-link" class="uk-input uk-form-small uk-width-expand uk-margin-small-right"
                               readonly style="font-size: 12px; background: var(--tg-theme-bg-color, #fff);">
                        <button type="button" class="copy-btn" onclick="copyNewCodeLink(this)">
                            <span uk-icon="icon: copy; ratio: 0.8"></span>
                            <?php echo Text::_('COM_RADICALMART_TELEGRAM_COPY'); ?>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <?php elseif ($this->codesLimitReached): ?>
        <div class="uk-margin-top uk-text-center">
            <p class="uk-text-warning uk-text-small">
                <span uk-icon="icon: warning; ratio: 0.8" class="uk-margin-small-right"></span>
                <?php echo Text::sprintf('COM_RADICALMART_TELEGRAM_REFERRALS_CODES_LIMIT_INFO', $this->codesLimit); ?>
            </p>
        </div>
        <?php endif; ?>
    </div>

    <?php if (!empty($this->parentChain)): ?>
    <div class="uk-card uk-card-default uk-card-body uk-margin-bottom">
        <h3 class="uk-card-title uk-margin-small-bottom">
            <span uk-icon="icon: chevron-double-left" class="uk-margin-small-right"></span>
            <?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_INVITED_BY'); ?>
        </h3>

        <div class="parent-chain">
            <?php foreach ($this->parentChain as $parent): ?>
            <div class="parent-chain-item">
                <span class="level-badge"><?php echo Text::sprintf('COM_RADICALMART_TELEGRAM_REFERRALS_LEVEL', $parent->level); ?></span>
                <span class="uk-text-emphasis"><?php echo htmlspecialchars($parent->name ?: $parent->masked_email); ?></span>
            </div>
            <?php endforeach; ?>
        </div>
    </div>
    <?php endif; ?>

    <div class="uk-card uk-card-default uk-card-body uk-margin-bottom">
        <h3 class="uk-card-title uk-margin-small-bottom">
            <span uk-icon="icon: users" class="uk-margin-small-right"></span>
            <?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_MY_REFERRALS'); ?>
            <?php if ($this->referralsCount > 0): ?>
            <span class="uk-badge"><?php echo $this->referralsCount; ?></span>
            <?php endif; ?>
        </h3>

        <?php if (empty($this->myReferrals)): ?>
        <p class="uk-text-muted uk-text-center uk-margin-small"><?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_NO_REFERRALS'); ?></p>
        <p class="uk-text-muted uk-text-small uk-text-center"><?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_SHARE_CODE_HINT'); ?></p>
        <?php else: ?>

        <div class="referral-tree">
            <?php foreach ($this->myReferrals as $ref): ?>
            <div class="referral-item">
                <div class="uk-flex uk-flex-middle">
                    <span class="level-indicator level-<?php echo min($ref->level, 5); ?>"><?php echo $ref->level; ?></span>
                    <div class="uk-width-expand">
                        <div class="uk-text-emphasis"><?php echo htmlspecialchars($ref->name ?: $ref->masked_email); ?></div>
                        <div class="uk-text-meta uk-text-small">
                            <?php echo HTMLHelper::_('date', $ref->created, 'd.m.Y'); ?>
                        </div>
                    </div>
                </div>

                <?php if (!empty($ref->sub_referrals)): ?>
                <div class="sub-referrals">
                    <?php foreach ($ref->sub_referrals as $sub): ?>
                    <div class="referral-item">
                        <div class="uk-flex uk-flex-middle">
                            <span class="level-indicator level-<?php echo min($sub->level, 5); ?>"><?php echo $sub->level; ?></span>
                            <div class="uk-width-expand">
                                <div class="uk-text-emphasis"><?php echo htmlspecialchars($sub->name ?: $sub->masked_email); ?></div>
                                <div class="uk-text-meta uk-text-small">
                                    <?php echo HTMLHelper::_('date', $sub->created, 'd.m.Y'); ?>
                                </div>
                            </div>
                        </div>

                        <?php if (!empty($sub->sub_referrals)): ?>
                        <div class="sub-referrals">
                            <?php foreach ($sub->sub_referrals as $sub2): ?>
                            <div class="referral-item">
                                <div class="uk-flex uk-flex-middle">
                                    <span class="level-indicator level-<?php echo min($sub2->level, 5); ?>"><?php echo $sub2->level; ?></span>
                                    <div class="uk-width-expand">
                                        <div class="uk-text-emphasis"><?php echo htmlspecialchars($sub2->name ?: $sub2->masked_email); ?></div>
                                        <div class="uk-text-meta uk-text-small"><?php echo HTMLHelper::_('date', $sub2->created, 'd.m.Y'); ?></div>
                                    </div>
                                </div>
                            </div>
                            <?php endforeach; ?>
                        </div>
                        <?php endif; ?>
                    </div>
                    <?php endforeach; ?>
                </div>
                <?php endif; ?>
            </div>
            <?php endforeach; ?>
        </div>

        <?php if ($this->hasMore): ?>
        <div class="uk-text-center uk-margin-top">
            <a href="<?php echo $root; ?>index.php?option=com_radicalmart_telegram&view=referrals<?php echo $baseQuery; ?>&start=<?php echo $this->start + $this->limit; ?>"
               class="uk-button uk-button-default uk-button-small">
                <?php echo Text::_('COM_RADICALMART_TELEGRAM_LOAD_MORE'); ?>
            </a>
        </div>
        <?php endif; ?>

        <?php endif; ?>
    </div>

    <?php endif; ?>
</div>

<div id="app-bottom-nav" class="uk-navbar-container" uk-navbar>
    <div class="uk-navbar-center uk-width-1-1 uk-flex uk-flex-center">
        <ul class="uk-navbar-nav">
            <li>
                <a href="<?php echo $root; ?>index.php?option=com_radicalmart_telegram&view=app<?php echo $baseQuery; ?>" class="tg-safe-text">
                    <span class="bottom-tab"><span uk-icon="icon: thumbnails"></span><span class="caption tg-safe-text"><?php echo Text::_('COM_RADICALMART_TELEGRAM_CATALOG'); ?></span></span>
                </a>
            </li>
            <li>
                <a href="<?php echo $root; ?>index.php?option=com_radicalmart_telegram&view=cart<?php echo $baseQuery; ?>" class="tg-safe-text">
                    <span class="bottom-tab"><span uk-icon="icon: cart"></span><span class="caption tg-safe-text"><?php echo Text::_('COM_RADICALMART_TELEGRAM_CART'); ?></span></span>
                </a>
            </li>
            <li>
                <a href="<?php echo $root; ?>index.php?option=com_radicalmart_telegram&view=orders<?php echo $baseQuery; ?>" class="tg-safe-text">
                    <span class="bottom-tab"><span uk-icon="icon: list"></span><span class="caption tg-safe-text"><?php echo Text::_('COM_RADICALMART_TELEGRAM_ORDERS'); ?></span></span>
                </a>
            </li>
            <li>
                <a href="<?php echo $root; ?>index.php?option=com_radicalmart_telegram&view=profile<?php echo $baseQuery; ?>" class="tg-safe-text">
                    <span class="bottom-tab"><span uk-icon="icon: user"></span><span class="caption tg-safe-text"><?php echo Text::_('COM_RADICALMART_TELEGRAM_PROFILE'); ?></span></span>
                </a>
            </li>
        </ul>
    </div>
</div>

<script>
function copyCodeLink(codeId, btn) {
    var input = document.getElementById('code-link-' + codeId);
    if (!input) return;

    navigator.clipboard.writeText(input.value).then(function() {
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }

        btn.classList.add('copied');
        var originalHtml = btn.innerHTML;
        btn.innerHTML = '<span uk-icon="icon: check; ratio: 0.8"></span> Скопировано';

        setTimeout(function() {
            btn.classList.remove('copied');
            btn.innerHTML = originalHtml;
        }, 2000);
    }).catch(function() {
        input.select();
        document.execCommand('copy');
        btn.classList.add('copied');
        setTimeout(function() { btn.classList.remove('copied'); }, 2000);
    });
}

function createReferralCode() {
    var customCodeInput = document.getElementById('custom-code-input');
    var customCode = customCodeInput ? customCodeInput.value.trim() : '';
    var btn = document.getElementById('create-code-btn');
    var form = document.getElementById('create-code-form');
    var result = document.getElementById('create-code-result');
    var errorDiv = document.getElementById('create-code-error');

    // Disable button and show loading
    btn.disabled = true;
    var originalBtnText = btn.innerHTML;
    btn.innerHTML = '<span uk-spinner="ratio: 0.5"></span> Создаём...';

    if (errorDiv) errorDiv.style.display = 'none';

    var formData = new FormData();
    formData.append('custom_code', customCode);

    fetch('<?php echo $root; ?>index.php?option=com_radicalmart_telegram&task=api.createReferralCode&format=raw<?php echo $baseQuery; ?>', {
        method: 'POST',
        body: formData
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            // Hide form, show result
            if (form) form.style.display = 'none';
            if (result) {
                result.style.display = 'block';

                var codeSpan = document.getElementById('new-code-value');
                var linkInput = document.getElementById('new-code-link');
                var discountSpan = document.getElementById('new-code-discount');

                if (codeSpan) codeSpan.textContent = data.data.code;
                if (linkInput) linkInput.value = data.data.link;
                if (discountSpan) discountSpan.textContent = data.data.discount || '';
            }

            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        } else {
            // Show error
            btn.disabled = false;
            btn.innerHTML = originalBtnText;

            if (errorDiv) {
                errorDiv.textContent = data.error || '<?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_CODE_CREATE_ERROR', true); ?>';
                errorDiv.style.display = 'block';
            }

            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            }
        }
    })
    .catch(function(error) {
        btn.disabled = false;
        btn.innerHTML = originalBtnText;

        if (errorDiv) {
            errorDiv.textContent = '<?php echo Text::_('COM_RADICALMART_TELEGRAM_REFERRALS_CODE_CREATE_ERROR', true); ?>';
            errorDiv.style.display = 'block';
        }

        console.error('Create code error:', error);
    });
}

function copyNewCodeLink(btn) {
    var input = document.getElementById('new-code-link');
    if (!input) return;

    navigator.clipboard.writeText(input.value).then(function() {
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }

        btn.classList.add('copied');
        var originalHtml = btn.innerHTML;
        btn.innerHTML = '<span uk-icon="icon: check; ratio: 0.8"></span> Скопировано';

        setTimeout(function() {
            btn.classList.remove('copied');
            btn.innerHTML = originalHtml;
        }, 2000);
    }).catch(function() {
        input.select();
        document.execCommand('copy');
        btn.classList.add('copied');
        setTimeout(function() { btn.classList.remove('copied'); }, 2000);
    });
}

function copyTgLink(codeId, btn) {
    var input = document.getElementById('tg-link-' + codeId);
    if (!input) return;

    navigator.clipboard.writeText(input.value).then(function() {
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }

        btn.classList.add('copied');
        var originalHtml = btn.innerHTML;
        btn.innerHTML = '<span uk-icon="icon: check; ratio: 0.8"></span> Скопировано';

        setTimeout(function() {
            btn.classList.remove('copied');
            btn.innerHTML = originalHtml;
        }, 2000);
    }).catch(function() {
        input.select();
        document.execCommand('copy');
        btn.classList.add('copied');
        setTimeout(function() { btn.classList.remove('copied'); }, 2000);
    });
}

// Initialize Telegram WebApp BackButton
document.addEventListener('DOMContentLoaded', function() {
    // Force light theme again
    document.documentElement.style.setProperty('--tg-theme-bg-color', '#ffffff');
    document.documentElement.style.setProperty('--tg-theme-text-color', '#222222');
    document.body.style.backgroundColor = '#ffffff';
    document.body.style.color = '#222222';

    try {
        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();

            // BackButton - navigate to profile
            try {
                Telegram.WebApp.BackButton.show();
                Telegram.WebApp.BackButton.onClick(function() {
                    window.location.href = '<?php echo $root; ?>/index.php?option=com_radicalmart_telegram&view=profile<?php echo $baseQuery; ?>';
                });
            } catch(e) { console.log('BackButton error:', e); }
        }
    } catch(e) {}
});
</script>

<!-- Bottom fixed nav -->
<div id="app-bottom-nav" class="uk-navbar-container" uk-navbar>
    <div class="uk-navbar-center uk-width-1-1 uk-flex uk-flex-center">
        <ul class="uk-navbar-nav">
            <li>
                <a href="<?php echo $root; ?>/index.php?option=com_radicalmart_telegram&view=app<?php echo $baseQuery; ?>" class="tg-safe-text">
                    <span class="bottom-tab"><span uk-icon="icon: thumbnails"></span><span class="caption tg-safe-text"><?php echo Text::_('COM_RADICALMART_TELEGRAM_CATALOG'); ?></span></span>
                </a>
            </li>
            <li>
                <a href="<?php echo $root; ?>/index.php?option=com_radicalmart_telegram&view=cart<?php echo $baseQuery; ?>" class="tg-safe-text">
                    <span class="bottom-tab"><span uk-icon="icon: cart"></span><span class="caption tg-safe-text"><?php echo Text::_('COM_RADICALMART_TELEGRAM_CART'); ?></span></span>
                </a>
            </li>
            <li>
                <a href="<?php echo $root; ?>/index.php?option=com_radicalmart_telegram&view=orders<?php echo $baseQuery; ?>" class="tg-safe-text">
                    <span class="bottom-tab"><span uk-icon="icon: list"></span><span class="caption tg-safe-text"><?php echo Text::_('COM_RADICALMART_TELEGRAM_ORDERS'); ?></span></span>
                </a>
            </li>
            <li class="uk-active">
                <a href="<?php echo $root; ?>/index.php?option=com_radicalmart_telegram&view=profile<?php echo $baseQuery; ?>" class="tg-safe-text">
                    <span class="bottom-tab"><span uk-icon="icon: user"></span><span class="caption tg-safe-text"><?php echo Text::_('COM_RADICALMART_TELEGRAM_PROFILE'); ?></span></span>
                </a>
            </li>
        </ul>
    </div>
</div>

<script>
// --- UIkit Icons Fix ---
function RMT_EXTRACT_ICON_NAME(attr){
    if (!attr) return '';
    let s = String(attr);
    const m = s.match(/icon\s*:\s*([^;]+)/);
    if (m && m[1]) return m[1].trim();
    return s.trim();
}
function RMT_FORCE_UKIT_ICONS(){
    try{
        if (!window.UIkit || !UIkit.icon) return false;
        const nodes = document.querySelectorAll('[uk-icon]');
        let forced = 0;
        nodes.forEach(el => {
            if (el.querySelector('svg')) return;
            const name = RMT_EXTRACT_ICON_NAME(el.getAttribute('uk-icon'));
            try { UIkit.icon(el, { icon: name }); forced++; } catch(_){}
        });
        if (forced>0) console.log('[RMT][icons] UIkit.icon forced for', forced, 'elements');
        try { UIkit.update(); } catch(_){}
        return forced>0;
    }catch(e){ return false; }
}

let RMT_ICON_OBSERVER = null;
function RMT_OBSERVE_ICONS(){
    try{
        if (RMT_ICON_OBSERVER) return;
        RMT_ICON_OBSERVER = new MutationObserver((mutations) => {
            let needsCheck = false;
            for (const m of mutations){
                if (m.type === 'childList'){
                    if (m.target && (m.target.hasAttribute?.('uk-icon') || m.target.querySelector?.('[uk-icon]'))) {
                        needsCheck = true; break;
                    }
                    for (const n of m.addedNodes){
                        if (n.nodeType === 1 && ((n.hasAttribute && n.hasAttribute('uk-icon')) || n.querySelector?.('[uk-icon]'))) { needsCheck = true; break; }
                    }
                }
                if (needsCheck) break;
            }
            if (needsCheck) { try { RMT_FORCE_UKIT_ICONS(); } catch(e){} }
        });
        RMT_ICON_OBSERVER.observe(document.documentElement || document.body, { childList: true, subtree: true });
    }catch(e){}
}

document.addEventListener('DOMContentLoaded', function(){
    RMT_FORCE_UKIT_ICONS();
    RMT_OBSERVE_ICONS();
});
</script>

</body>
</html>
