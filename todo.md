# Telegram Bot для RadicalMart — План работ

Цель: реализовать дополнительный компонент Joomla 5 (`com_radicalmart_telegram`) для интеграции магазина RadicalMart в Telegram (диалоговый бот/мини‑приложение), с поддержкой каталога, корзины, оформления заказа, оплаты, доставки (ApiShip), промокодов и бонусов, уведомлений о статусах заказов.

Источники интеграции:
- Каталог/корзина/оформление: `components/com_radicalmart` (модели/контроллеры: Cart/Products/Checkout/Payment).
- Промокоды/баллы/рефералы: `components/com_radicalmart_bonuses` + `plugins/radicalmart/bonuses`.
- Доставка: `plugins/radicalmart_shipping/apiship`.
- Оплаты: `plugins/radicalmart_payment/*`.
- Telegram‑уведомления: `plugins/radicalmart_message/telegram` (для каналов/чатов; можно переиспользовать для персональных уведомлений после привязки чата).

## Дорожная карта (итерации)

М0. Аналитика и решения (0.5–1 дн)
- [ ] Подтвердить формат бота: классический чат‑бот, Mini App (WebApp) или гибрид.
- [ ] Утвердить способ оплаты: внешняя ссылка (`com_radicalmart` → `PaymentController::pay`) vs Telegram Payments (опционально).
- [ ] Определить UX доставки: локация → ApiShip тарифы или ручной ввод адреса.
- [ ] Решить схему авторизации: гость → привязка к пользователю (одноразовый код) → постоянная связь.
- [ ] Список минимального MVP и что уходит в backlog.

Предварительные решения (от клиента):
- Гибрид: чат‑диалоги + Mini App (WebApp) в Telegram. Поддерживаем мобильные и desktop‑клиенты.
- Оплаты:
  - Внутри Telegram: Telegram Payments (карты) + Telegram Stars. Провайдеры карт: YooKassa, Robokassa.
  - По ссылке вне Telegram: Yandex Pay и Tinkoff.
  - Stars: курс из RUB + наценка за конвертацию (процент — в настройках).
- Функционал: полный магазин в боте — каталог, карточки, корзина, выбор оплаты/доставки, выбор ПВЗ на карте, отправка заказа на сайт.
- Доставка: только ПВЗ (без курьерской). На карту подгружаем ПВЗ в текущих границах (bounding box) без загрузки всех точек сразу. Допускается доработка `plg_radicalmart_shipping_apiship` под запрос ПВЗ по bbox.
- Авторизация: базово Telegram ID. При оформлении запрашиваем телефон через Telegram contact (requestContact) и сохраняем в БД для будущей авторизации. Если номер не отправлен — fallback авторизация в боте через SMS/звонок (sms.ru) с использованием `com_j_sms_registration`.
- Брошенные корзины: реализуем все варианты напоминаний; параметры включаются в настройках.
- Онлайн‑режим (опционально):
  - Трекер доставки по номеру отправления (Яндекс Доставка, СДЭК, 5post).
  - Уведомление «товар появился в наличии» раз в день или по кнопке в админке (настройка). Для мета‑товаров — отправлять ссылку на вариант с минимальным весом (чтобы не дублировать).
  - Inline‑режим как чат поддержки.
- Каталог: нужны фильтры и сортировки (уточним позже). «Подгружаемая» выдача вместо пагинации. Товары «нет в наличии» помечать и опускать в конец. Единственная опция — вес.
- Локализация: русский язык, шаблоны сообщений обязательны.
- Политика данных: по закону РФ, отдельные согласия/галочки (рассылки и пр.).
- Инфраструктура: домен `cacao.land`, все как компонент Joomla 5, WebApp подключаем к Telegram через разрешённые домены у BotFather. Логи — стандартный Joomla Log.

M0 — Вопросы к согласованию
1) Формат и UX Mini App
   - Подтвердите гибрид: чат‑диалоги + WebApp для сложных экранов (каталог, карта ПВЗ, оформление)?
   - На каких платформах обязательна поддержка: iOS/Android/desktop Telegram?
2) Оплаты
   - Провайдеры Telegram Payments подтверждены: YooKassa, Robokassa. Нужны `provider_token` для каждого.
   - Telegram Stars: подтверждаем применимость (для каких товаров) и правила возврата.
   - Приоритезация: правилом по типу товара (физические/цифровые) и/или по сумме? Уточнить.
3) Доставка и карта ПВЗ
   - Подтверждаем Yandex.Maps. Нужны API‑ключ(и) и ограничения по тарифу.
   - Для ПВЗ: делаем облегчённый UI в WebApp с подгрузкой точек по текущим границам карты (bbox). Опционально доработать плагин ApiShip (endpoint/события) под bbox.
   - Курьерская не нужна.
4) Авторизация и `com_j_sms_registration`
   - Доверяем номеру из Telegram contact (requestContact). Если нет — SMS/звонок через sms.ru (посредством `com_j_sms_registration`).
   - При совпадении телефона с существующим пользователем: связываем `chat_id`↔`user_id` и логиним автоматически — подтвердить.
   - Политика повторных привязок (несколько Telegram к одному номеру) — уточнить.
5) Брошенные корзины
   - Сделать все варианты напоминаний. Уточнить дефолтный график: через X минут/часов, N повторов, «тихие» часы.
   - Opt‑in пользователя: включать при первом добавлении в корзину? Где фиксировать согласие.
6) Онлайн‑режим
   - Подтверждаем: live‑трекер доставки по номеру отправления (Яндекс Доставка, СДЭК, 5post) + «товар появился в наличии» (раз в день/по кнопке).
   - Inline‑режим «чат поддержки»: платформа/бэк‑офис (Telegram чат/CRM) — уточнить.
7) Каталог и карточка
   - Фильтры/сортировки — нужны (уточнить список и приоритет). Выдача — подгружаемая (без пагинации), лимиты по партии и стратегия «нет в наличии в конец».
   - Опции: только «вес» — UX выбора в боте (кнопки/селект) — уточнить.
8) Локализация и тексты
   - Только ru-RU или мультиязык? Нужны ли отдельные шаблоны сообщений для бота?
9) Политика данных и согласий
   - Формулировки согласий на обработку ПДн/уведомления в чате; где показываем и как фиксируем согласие.
10) Инфраструктура
   - Домен/SSL: `cacao.land` (включить в список разрешённых доменов у BotFather для WebApp). Нужен ли сабдомен для изоляции WebApp?
   - Логи: только средствами Joomla 5; настройки каналов/файлов и ретенция — уточнить.

Ответы клиента (M0 — подтверждено)
1) Формат и UX
- Гибрид чат + WebApp в Telegram, поддержка iOS/Android/desktop клиентов.

2) Оплаты
- Telegram Payments: провайдеры YooKassa и Robokassa, для каждого будут отдельные `provider_token` (test/prod). Поддержать возвраты и частичные возвраты.
- Telegram Stars: доступно для всех товаров (настраиваем исключения по категориям/товарам), курс из RUB + % конвертации из настроек.
- Приоритет методов и применимость настраиваются (категории/товары/глобально).

3) Доставка/ПВЗ
- Ключи Yandex.Maps есть. ПВЗ подгружаем по bbox в WebApp. Рассмотреть отдельный плагин под бота и доработку текущего ApiShip.

4) Авторизация
- При совпадении телефона — сразу логиним и связываем `chat_id`↔`user_id`.
- Политика: один Telegram ID на один номер. Задача: продумать обработку несостыковок/разлинковку.

5) Брошенные корзины
- График: 1) через 1 час, 2) через 24 часа, 3) через 3 дня; «тихие часы» 22:00–9:00.

6) Онлайн‑режим
- Трекер отправлений: Яндекс Доставка, СДЭК, 5post.
- Restock: рассылка «появился в наличии» раз в день или вручную из админки; для мета‑товаров — ссылка на вариант с минимальным весом.
- Поддержка: отдельный операторский бот в Telegram (логика маршрутизации — проработать отдельно).

7) Каталог
- Фильтры/сортировки нужны; уточним состав при реализации. Выдача подгружаемая, «нет в наличии» — в конец. Опция товара — «вес».

8) Локализация
- Русский язык, шаблоны сообщений обязательны.

9) Политика данных
- По закону РФ, согласия/галочки, рассылки — учет и хранение согласий.

10) Инфраструктура
- Домен `cacao.land`, всё в компоненте Joomla 5; WebApp подключаем через разрешённые домены BotFather. Логи — стандарт Joomla 5.

Критерии приемки:
- Протокол решений, макеты диалогов, список поддерживаемых платежей и служб доставки.

М1. Каркас компонента `com_radicalmart_telegram` (1 дн)
- [x] Манифест компонента (site+admin), базовая маршрутизация, контроллер `WebhookController`.
- [ ] Сервис‑слой: Telegram API client, построитель сообщений/клавиатур, обработчик апдейтов.
- [x] Конфиг в админке: `bot_token`, `webhook_secret`, флаги фич.
- [x] Site view `app` с минимальным layout (пока `tmpl=component`; отдельный `tgwebapp` — далее).
- [x] Настройка названия магазина (`store_title`) для кнопок/сообщений (по умолчанию «магазин Cacao.Land»), языковые файлы admin.

Критерии приемки:
- Компонент устанавливается, отображает страницу настроек, есть endpoint вебхука: `index.php?option=com_radicalmart_telegram&task=webhook.receive&secret=...`.

М2. База данных (0.5 дн)
- [x] SQL установки: `#__radicalmart_telegram_users` (chat_id, user_id, username, phone, locale, consent).
- [x] SQL установки: `#__radicalmart_telegram_sessions` (chat_id, state, payload, cart_snapshot, expires_at).
- [x] SQL установки: `#__radicalmart_telegram_links` (one‑time codes для привязки Telegram↔User).

Критерии приемки:
- Таблицы создаются/удаляются при установке/удалении, индексы по chat_id/user_id.

М3. Вебхук и парсинг команд (1 дн)
- [x] Валидация `secret`.
- [x] Базовый обработчик апдейтов и клиент Telegram (заготовка): `/start`/`/help`.
- [ ] Логирование, защита от повторов.
- [ ] Команды: `Каталог`, `Корзина`, `Оформить заказ`, `Мои заказы`, `Промокод`, `Баллы`.
- [ ] Состояния диалога: idle → browsing → product → cart → checkout → payment.

Критерии приемки:
- Бот отвечает на команды, переключает состояния, есть кнопки/клавиатуры.

М4. Каталог и поиск (1 дн)
- [ ] Дерево категорий, пагинация, быстрый поиск (название/артикул).
- [ ] Карточка товара: фото, цена(ы), наличие, опции/вариации.
- [ ] Кнопки: Добавить в корзину, Избранное (если включено), Поделиться.

Критерии приемки:
- Навигация по категориям и просмотр товаров без ошибок.

М5. Корзина и оформление (1–2 дн)
- [ ] Хранение корзины в `sessions` (для гостя) и привязка к `user_id` при авторизации.
- [ ] Промокоды/баллы: ввод/применение, валидация, пересчёт сумм через модели RadicalMart.
- [ ] Контакты: запрос телефона (через Telegram contact), ФИО, email.

Критерии приемки:
- Добавление/удаление/изменение позиций, применение промокода и/или баллов, корректные суммы.

М6. Доставка (ApiShip) (1 дн)
- [ ] Запрос адреса: геолокация/ручной ввод → нормализация (DaData если доступно).
- [ ] Получение тарифов через события плагина ApiShip (`onRadicalMartGetOrderShippingMethods`/AJAX‑хелперы) и выбор варианта.
- [ ] Поддержка ПВЗ: выдача списка, выбор ПВЗ.

Критерии приемки:
- Для заданного адреса возвращаются тарифы, выбор сохраняется в сессии.

М7. Создание заказа и оплата (0.5–1 дн)
- [ ] Сбор `jform` для `CheckoutModel::createOrder`, привязка корзины, автора (`created_by`).
- [ ] Возврат номера заказа и ссылки на оплату (`index.php?option=com_radicalmart&task=payment.pay&order_number=...`).
- [ ] Обработка статусов оплаты (через callback платёжных плагинов → уведомление в Telegram).

Критерии приемки:
- Заказ создаётся, оплата по ссылке открывается, статусы дойдут до пользователя в Telegram.

М8. Уведомления и привязка пользователей (0.5 дн)
- [ ] Механизм привязки: одноразовый код на сайте → отправка боту → сохранение `chat_id`↔`user_id`.
- [ ] Уведомления о статусах заказа: интеграция с `plg_radicalmart_message_telegram` или прямые сообщения из компонента.

Критерии приемки:
- Пользователь получает личные уведомления по смене статуса.

М9. Админка (1 дн)
- [ ] Управление пользователями бота (поиск/развязка), открытые сессии, последние ошибки.
- [ ] Настройки фич (промо/баллы/рефералка/доставка), локализация сообщений.
- [ ] CLI: установка/удаление webhook, рассылки, служебные задачи.

Критерии приемки:
- Раздел настроек и списки в админке работают, CLI команды выполняются.

М10. Безопасность, логирование, DX (0.5 дн)
- [ ] Rate‑limit по chat_id, защита от повторной обработки апдейтов.
- [ ] Централизованный лог (Joomla Log) + debug‑флаги.
- [ ] Фолбэки ошибок для пользователя.

М11. Тестирование и документация (0.5 дн)
- [ ] Smoke‑тесты сценариев: каталог → корзина → оформление → оплата.
- [ ] Документация по установке и эксплуатации.

## Технические детали и привязки

- Каталог/оформление:
  - Использовать модели `com_radicalmart`: `ProductsModel`, `CartModel`, `CheckoutModel`, `PaymentModel`.
  - Создание заказа: `CheckoutModel::createOrder($data)` с корректной сборкой `jform` и `created_by`.
  - Оплата: ссылка на `PaymentController::pay` (плагин оплаты определяется из заказа).

- Промокоды/баллы:
  - Плагин `plugins/radicalmart/bonuses` дополняет форму заказа и расчёт — переиспользовать логику через модель/события.
  - Просмотр баланса и кодов: модели `com_radicalmart_bonuses` (Points/Codes).

- Доставка (ApiShip):
  - Вычисление тарифов: события `onRadicalMartGetOrderShipping*` или AJAX‑обработчик `onAjaxApiship`.
  - Адрес: структура полей по `ApiShip::$defaultAddressFieldsParams`.

- Уведомления:
  - Базово: `plugins/radicalmart_message/telegram` уже умеет рассылать в каналы/чаты по событиям `radicalmart.order.*`.
  - Для персональных уведомлений — хранить `chat_id` у пользователя и отправлять напрямую.

### Telegram Payments (карты и звёзды) — задачи
- [ ] Получить `provider_token`(ы) для YooKassa и Robokassa.
- [x] Сформировать Invoice и payload (order_number), обработать `pre_checkout_query`/`successful_payment` (уведомление в чате; статус заказа пока без изменений).
- [ ] Для физических заказов сохранить поток доставки внутри WebApp и завершать оплатой по ссылке (fallback), если провайдер недоступен.
- [ ] Telegram Stars: настроить прайсинг (курс из RUB + % конвертации), маппинг товара→кол‑во Stars, ограничения возвратов.
- [ ] Синхронизация статусов: при успехе оплаты в Telegram — обновлять заказ в RadicalMart и слать персональное уведомление.
- [ ] Настройки: включение/выключение Telegram Payments по типу товара/категории/сумме заказа.
- [ ] Возвраты/частичные возвраты: интерфейсы в админке, синхронизация статуса, ограничения провайдеров.
- [ ] Плагинная архитектура оплаты: абстракции для провайдеров Telegram Payments и Stars.

### Доставка и карта ПВЗ — задачи
- [x] Веб‑UI WebApp с картой Yandex.Maps и подгрузкой ПВЗ по bbox.
- [x] Серверный endpoint для выдачи ПВЗ по bbox (`api.pvz` в `com_radicalmart_telegram`).
- [x] Выбор ПВЗ и сохранение в сессии бота (`api.setpvz`) → отображение в summary.
- [x] UI: спиннер/ошибки при загрузке ПВЗ, ссылка «Сменить» в summary.
- [ ] Кеширование ПВЗ/тайл‑стратегия и лимиты запросов к ApiShip (дополнительно к недельной полной выгрузке).
- [ ] Отдельный плагин для карты/ПВЗ под Telegram (по необходимости) + доработка `plg_radicalmart_shipping_apiship` для bbox.

### Авторизация — задачи
- [ ] Поток: Telegram ID + запрос телефона (requestContact) → связывание с пользователем сайта.
- [ ] Fallback: SMS/звонок через `com_j_sms_registration` (sms.ru), если телефон не отправлен.
- [ ] Маппинг `chat_id`↔`user_id` и автоматический логин при совпадении телефона.
- [ ] Политика повторных привязок и разлинковки в админке.
- [ ] Ограничение 1:1 между Telegram ID и номером телефона; обработка конфликтов и сценарии разлинковки (UI в админке).

### Брошенные корзины — задачи
- [ ] Трекинг незавершённых корзин в сессиях бота.
- [ ] Конфиг графиков: X минут/часов, N повторов, тихие часы.
- [ ] Opt‑in пользователя и хранение согласия.
- [ ] Шаблоны сообщений и deep‑links для возврата к корзине/товарам.

### Онлайн‑режим — задачи
- [ ] Трекер доставки: интеграция со службами (Яндекс Доставка, СДЭК, 5post) по номеру отправления из заказа.
- [ ] Restock: планировщик раз в день + ручной запуск из админки; выборка товаров «в наличии» и рассылка.
- [ ] Restock для мета‑товаров: отправлять ссылку на вариант с минимальным весом.
- [ ] Inline‑режим «чат поддержки»: сценарий и маршрутизация сообщений (операторы/CRM).
- [ ] Отдельный операторский бот: приём/эскалация сообщений, связь с заказами/пользователями.

### WebApp — задачи
- [ ] Настроить разрешённые домены у BotFather (включая `https://cacao.land`).
- [ ] Бутстрап WebApp: проверка `initData`, верификация хеш‑подписи.
- [ ] UI: каталог/карточка/корзина/оформление, карта ПВЗ, платежные экраны.
- [ ] Шина событий: синхронизация состояния между чат‑диалогом и WebApp.
- [ ] Режим «минимальный шаблон» для WebApp‑страниц (отдельный tmpl без лишних ассетов Joomla).

## Архитектурные варианты и рекомендации (Joomla 5)
- Вариант A: Компонент `com_radicalmart_telegram` (site+admin), все вебхуки/веб‑страницы WebApp как view компонента.
  - Плюсы: единая ACL/сессия, простая интеграция с моделями RadicalMart, стандартные логи.
  - Минусы: нужно изолировать front (минимальный шаблон), следить за кэшированием/ассетами.
- Вариант B: Тот же компонент + отдельный минималистичный шаблон страницы (`tmpl=tgwebapp`) или `tmpl=component`.
  - Плюсы: чистый front, быстрые страницы WebApp, меньше конфликтов CSS.
  - Минусы: два набора layout’ов/ассетов для поддержки.
- Вариант C: Отдельный микросервис (не рекомендуется сейчас) за сабдоменом, API к Joomla.
  - Плюсы: полная изоляция фронта.
  - Минусы: лишняя инфраструктура и мост авторизации. Для текущей задачи избыточно.

Рекомендация: A+B — компонент с отдельным облегчённым шаблоном для WebApp‑экранов и эндпойнтами вебхука/ПВЗ.

## Backlog/идеи улучшений
- Mini App (WebApp) с нативной оплатой/адресной формой, smooth UX.

## M3 — Прогресс (обновлено)
- [x] Логирование (канал `com_radicalmart.telegram`, файл `com_radicalmart_telegram.php`).
- [x] Идемпотентность обработчика вебхука (по `update_id` в `#__radicalmart_telegram_sessions`).
- [x] Заглушки команд: Каталог/Корзина/Оформить заказ/Мои заказы/Промокод/Баллы.
- [x] Сохранение состояния сессии при командах (state: browsing/cart/checkout/etc).
- [x] Кнопка открытия: теперь текст динамический — «Открыть {store_title}» (по умолчанию «магазин Cacao.Land») вместо «Открыть WebApp».
- [x] Кнопка WebApp в сообщениях (inline `web_app` → `view=app`).
- [x] Мини‑каталог в чате: вывод первых N товаров через `ProductsModel`.
- [x] Базовые переходы состояний: browsing/product/cart на командах и коллбеках.
- [x] Пагинация каталога в чате (callback `catalog:page:N`) с редактированием сообщения.
- [x] Детали товара в чате: название, категория, производитель, наличие, цена (по шаблонам YOOtheme overrides) + кнопки «В корзину»/«К каталогу».
- [x] WebApp layout `layout=webapp`: подключены UIkit JS и YOOtheme CSS, базовый каркас (каталог/корзина/оформление).
  - [x] Заголовок/логотип используют {store_title} из настроек компонента.
- [x] Реальное добавление в корзину (чат) через `CartModel->addProduct` + хранение `cart.id/code` в сессии.
- [x] Отображение корзины в чате (позиции, количество, сумма) и кнопки «Оформить»/«Каталог».
- [x] WebApp API (простое): список товаров, добавление в корзину, получение корзины по `chat`.
- [x] WebApp: подгрузка каталога и обновление корзины на UIkit.
- [x] Управление корзиной в чате: +/-/Удалить (inline клавиатура для первых позиций), с редактированием сообщения.
- [ ] FSM состояний: завершить сценарии product → cart → checkout → payment.
- [x] Валидация в WebApp: ФИО (обяз. Имя/Фамилия), телефон (нормализация +7 и проверка формата), email (простая проверка), выбранные доставка/оплата, блокировка оформления при пустой корзине.
- [x] Серверная валидация: очистка и проверка телефона, проверка email, мягкая проверка выбранных доставки/оплаты.
- [x] API методы setshipping/setpayment: проверка, что id входит в доступные методы; пересчёт summary.
- [x] Маска телефона (UI): подключён IMask через CDN; поддерживает ввод начиная с 8, с 9xx… и с +7, нормализуем к +7 при отправке.
 - [x] Маска телефона (UI): реализована локально без внешних зависимостей; поддерживает ввод начиная с 8, с 9xx… и с +7, нормализуем к +7 при отправке; добавлена подсказка под полем.
- [x] Перевели UIkit JS c CDN на локальные файлы из шаблона YOOtheme.
- [x] Создан файл-реестр содержимого пакета установщика: `docs/installer-package.md` (вести список до финальной сборки).
- [x] Добавлен язык RU для site-части компонента: `components/com_radicalmart_telegram/language/ru-RU/com_radicalmart_telegram.ini`; ключевые строки вынесены в языковые константы и подключены в `tgwebapp.php`.
 - [x] Промокоды/баллы в WebApp: поля, список применённых кодов, применённые баллы; API `promocode`, `points`, `summary` возвращает `codes[]/points`.
- [x] Показ доступного баланса баллов (API `bonuses`), отображение возле поля.
 - [x] В summary показываем скидку по каждому применённому промокоду (агрегация по позициям заказа) и применённые баллы.
- Реферальные ссылки и начисления через бота (компонент бонусов).
- Напоминания о брошенной корзине (opt‑in), ретаргетинг акций.
- Inline‑режим: быстрое шаринг‑поиск товара в чате.
- Быстрые повторные заказы и подписки на товары.

## Открытые вопросы
- Telegram Payments vs внешняя оплата для РФ/локальных провайдеров.
- Требования к персональным данным в чате (политика, согласия).
- Требуется ли поддержка гостевого оформления без привязки к пользователю Joomla.

### Мелкие UX/текстовые правки (выполнено)
- [x] Приветствие: «Добро пожаловать в {store_title}!» вместо жёсткого текста.
- [x] Все упоминания «WebApp» в пользовательских кнопках заменены на «{store_title}».

### Следующие шаги по оформлению (MVP)
- [x] Блок выбора способа доставки в WebApp: использовать дефолтный метод из RadicalMart; отображать название тарифа и стоимость в summary.
- [x] Поля промокода/баллов: валидация и пересчёт суммы через модели RadicalMart; добавлены API `promocode` и `points`, UI списков/значений.
- [x] Обработка пустой корзины при оформлении: блокировка на клиенте и сообщения.
- [x] Мягкая маска телефона (локально) + нормализация к +7 и валидация.
- [x] ПВЗ: спиннер/ошибки при загрузке, показ выбранного ПВЗ в summary + ссылка «Сменить».
- [x] ПВЗ: серверный endpoint `api.pvz` и выбор `api.setpvz` готовы; добавлена санитизация `providers/limit/bbox`.
- [x] ПВЗ‑UX: чекбоксы провайдеров (из настроек), подсветка выбранного ПВЗ на карте и в списке, скролл к карте по «Сменить», центрирование карты и открытие balloon при выборе, inline‑ошибка под картой.
- [x] Кеш bbox‑ответов api.pvz (файловый TTL), параметры в админке (включение, TTL сек, точность bbox); счётчик найденных ПВЗ в WebApp.
- [x] WebApp: передаём `initData` Telegram в каждый API вызов (параметр `tg_init`).
- [x] Сервер: мягкая проверка `initData` (подпись HMAC по `bot_token`) во всех API-методах.
- [x] Настройка «Строгая проверка initData» в админке (по умолчанию выключена).
- [x] Базовый rate‑limit per-session по `chat_id` для API (в т.ч. `pvz`).
- [x] DB rate‑limit per chat/tg_user: таблица + подключено во все API.
- [x] Nonce: таблица, серверная проверка (опционально строгая), nonce в WebApp для мутаций.
- [x] Admin «PVZ Status» (last_fetch/last_total + кнопка).
- [x] Admin «Привязки пользователей»: список связок chat_id/tg_user_id/user_id/phone.
- [x] Консоль: housekeeping для очистки nonces/ratelimits.
- [x] Admin: «PVZ Status» — список провайдеров (last_fetch, last_total) + кнопка ручной выгрузки.

### Заказы (личный кабинет в WebApp)
- [x] Endpoint `api.orders` — список последних заказов пользователя (по привязке chat_id↔user_id).
- [x] WebApp: раздел «Мои заказы» — номер, статус, сумма, кнопка «Оплатить» при наличии ссылки.
- [ ] Пагинация/подгрузка более ранних заказов; фильтры по статусу.

## Платежи (прогресс/план)
- [x] Настройки Telegram Payments в компоненте (env/provider/tokens)
- [x] TelegramClient: sendInvoice/preCheckout
- [x] Webhook: pre_checkout_query/successful_payment (уведомление)
- [x] Плагины RM (scaffold): telegramcards/telegramstars
- [x] Привязать successful_payment к смене статуса заказа по payload `order:<number>` (статус из настроек компонента)

## Согласия и рассылки (ФЗ-152, интеграция AcyMailing)
- [x] **БД**: добавлены поля consent_personal_data/consent_marketing/consent_terms + timestamps в `#__radicalmart_telegram_users`
- [x] **Миграция**: `5.0.1.sql` переименовывает старые поля и добавляет новые
- [x] **Документы**: созданы шаблоны (consent-personal-data.md, privacy-policy.md, terms-of-service.md, consent-marketing.md)
- [x] **Реквизиты**: все документы обновлены с актуальными данными ИП Гутников С.В.
- [x] **Логика бота**: при `/start` сначала проверяется согласие на ПД, потом запрос телефона
- [x] **Callback**: `consent_accept` сохраняет согласие с timestamp
- [x] **ConsentHelper**: методы для получения URL юридических документов из настроек компонента
- [x] **Настройки**: добавлены поля для выбора статей Joomla с юридическими документами (config.xml)
- [x] **Языковые константы**: добавлены переводы для полей выбора статей (ru/en)
- [ ] **WebApp**: проверка согласий при первом открытии, модальное окно с ссылками на политики
- [ ] **Интеграция AcyMailing**: синхронизация consent_marketing с подпиской/отпиской в AcyMailing
  - [ ] При принятии согласия на рассылку → добавить в лист AcyMailing
  - [ ] При отзыве → отписать из листа
  - [ ] Двусторонняя синхронизация: webhook AcyMailing → обновление таблицы бота
  - [ ] Настройка ID листа AcyMailing в конфиге компонента
- [ ] **Функционал рассылок в боте** (будущее):
  - [ ] Админка: создание рассылки (текст, кнопки, медиа)
  - [ ] Фильтры получателей (все/согласившиеся/с покупками/регион)
  - [ ] Планировщик отправки (сразу/по расписанию)
  - [ ] Статистика: доставлено/прочитано/кликнуто
  - [ ] Template engine для персонализации ({name}, {bonus_balance})
  - [ ] Rate limiting для массовых рассылок (чанки по 30 msg/sec)
  - [ ] Отписка через inline-кнопку или команду /unsubscribe
- [ ] **Команды управления подписками**:
  - [ ] `/settings` → показ текущих согласий + inline-кнопки вкл/выкл
  - [ ] `/revoke_consent` → отзыв согласия на ПД (с предупреждением)
  - [ ] `/revoke_marketing` → отписка от рассылок
- [ ] **Языковые константы**: добавить тексты для управления подписками
- [x] WebApp: при выборе «Оплата в Telegram» — показывать «Счёт отправлен в чат» (без редиректа)
- [x] Повторная отправка счёта: API `api.invoice` + кнопка «Отправить счёт ещё раз» в WebApp
- [x] «Мои заказы»: кнопка «Отправить счёт» для TG‑способов (API `orders` возвращает `can_resend`)
- [ ] Возвраты/частичные возвраты (Cards)
 - [x] Возвраты/частичные возвраты (admin‑отметка): добавлен admin‑инструмент (view=payments) для отметки возврата/частичного возврата (смена статуса и лог).
 - [x] Админ: валидация суммы (<= итога заказа) и показ результата провайдера (сообщение из плагина) при отметке возврата.
 - [x] Refund API (MVP): Telegram Cards — вызов YooKassa /v3/refunds (по provider_payment_charge_id), Robokassa — плейсхолдер; запись результата в лог.
- [x] Telegram Stars: расчёт по курсу/наценка, инвойс XTR; ограничение по категориям (allowed_categories)
- [x] Telegram Stars: конфиг полей в плагине (rub_per_star, conversion_percent, allowed/excluded cats/products); скрывать метод на клиенте при несоответствии правилам
- [x] Telegram Stars: заглушка возвратов (refund) — не поддерживается (hook onRadicalMartPaymentRefund)
- [x] Packaging: добавлены site RU‑язык в манифест компонента и языки плагинов в их манифесты.

## Безопасность (запланировано)
- [ ] Связка `tg_user.id` ↔ `chat_id` из initData; пер‑чатный rate‑limit в БД (не только сессионный).
- [ ] Защита от повторов (nonce) на мутациях: add/qty/remove/setshipping/setpayment/setpvz/checkout.
  - [x] БД и проверка готовы; осталось подключить требования по мере включения флага в проде и мониторинг в админке.
- [ ] Показ доступного баланса баллов (из RadicalMart_Bonuses) и ограничений.
- [ ] Показ скидок по каждому промокоду (суммы) и итоговых скидок в summary.
- [ ] Локализация всех уведомлений (UIkit.notification) — проверка/добивка.
